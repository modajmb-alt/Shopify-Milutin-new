{%- liquid
  assign products_per_page = section.settings.products_per_page
  assign columns_desktop = section.settings.columns_desktop
  assign columns_mobile = section.settings.columns_mobile
  assign enable_filtering = section.settings.enable_filtering
  assign enable_sorting = section.settings.enable_sorting
  assign filter_style = section.settings.filter_style
-%}

<section class="collection" data-section-id="{{ section.id }}">
  <div class="container">
    {% render 'breadcrumbs' %}
    {%- paginate collection.products by products_per_page -%}

      {%- if enable_filtering or enable_sorting -%}
        <div class="collection__toolbar">
          <div class="collection__toolbar-left">
            {%- if enable_filtering -%}
              <button
                type="button"
                class="collection__filter-toggle"
                aria-expanded="false"
                aria-controls="CollectionFilters"
                data-filter-toggle
              >
                {% render 'icon-filter' %}
                <span>{{ 'collections.filter' | t }}</span>
                {%- if collection.filters.size > 0 -%}
                  {%- assign active_filters_count = 0 -%}
                  {%- for filter in collection.filters -%}
                    {%- assign active_filters_count = active_filters_count | plus: filter.active_values.size -%}
                  {%- endfor -%}
                  {%- if active_filters_count > 0 -%}
                    <span class="collection__filter-count">({{ active_filters_count }})</span>
                  {%- endif -%}
                {%- endif -%}
              </button>
            {%- endif -%}
          </div>

          <div class="collection__toolbar-center">
            <span class="collection__count">
              {{ 'collections.product_count' | t: count: collection.products_count }}
            </span>
          </div>

          <div class="collection__toolbar-right">
            {%- if enable_sorting -%}
              <div class="collection__sort">
                <label for="SortBy" class="visually-hidden">{{ 'collections.sort_by' | t }}</label>
                <select id="SortBy" class="collection__sort-select" data-sort-select>
                  {%- for option in collection.sort_options -%}
                    <option value="{{ option.value }}" {% if option.value == collection.sort_by %}selected{% endif %}>
                      {{ option.name }}
                    </option>
                  {%- endfor -%}
                </select>
                {% render 'icon-chevron' %}
              </div>
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}

      <div class="collection__content">
        {%- if enable_filtering and filter_style == 'drawer' -%}
          {% render 'collection-filters-drawer', collection: collection %}
        {%- endif -%}

        {%- if enable_filtering and filter_style == 'sidebar' -%}
          <aside class="collection__sidebar">
            {% render 'collection-filters', collection: collection %}
          </aside>
        {%- endif -%}

        <div class="collection__main">
          {%- if collection.products.size > 0 -%}
            <ul class="collection__grid collection__grid--{{ columns_desktop }}-col collection__grid--mobile-{{ columns_mobile }}-col" role="list" data-collection-grid>
              {%- for product in collection.products -%}
                <li class="collection__item" data-animate data-animate-delay="{{ forloop.index | modulo: 4 | times: 100 }}">
                  {% render 'product-card', product: product %}
                </li>
              {%- endfor -%}
            </ul>

            {%- if paginate.pages > 1 -%}
              <nav class="pagination" aria-label="{{ 'collections.pagination' | t }}">
                <ul class="pagination__list" role="list">
                  {%- if paginate.previous -%}
                    <li>
                      <a href="{{ paginate.previous.url }}" class="pagination__link pagination__link--prev" aria-label="{{ 'collections.previous' | t }}">
                        &larr;
                      </a>
                    </li>
                  {%- endif -%}

                  {%- for part in paginate.parts -%}
                    <li>
                      {%- if part.is_link -%}
                        <a href="{{ part.url }}" class="pagination__link">{{ part.title }}</a>
                      {%- else -%}
                        {%- if part.title == paginate.current_page -%}
                          <span class="pagination__link pagination__link--current" aria-current="page">{{ part.title }}</span>
                        {%- else -%}
                          <span class="pagination__link pagination__link--gap">{{ part.title }}</span>
                        {%- endif -%}
                      {%- endif -%}
                    </li>
                  {%- endfor -%}

                  {%- if paginate.next -%}
                    <li>
                      <a href="{{ paginate.next.url }}" class="pagination__link pagination__link--next" aria-label="{{ 'collections.next' | t }}">
                        &rarr;
                      </a>
                    </li>
                  {%- endif -%}
                </ul>
              </nav>
            {%- endif -%}

          {%- else -%}
            <div class="collection__empty">
              <p>{{ 'collections.empty' | t }}</p>
              {%- if collection.filters.size > 0 -%}
                {%- assign has_active_filters = false -%}
                {%- for filter in collection.filters -%}
                  {%- if filter.active_values.size > 0 -%}
                    {%- assign has_active_filters = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_active_filters -%}
                  <a href="{{ collection.url }}" class="btn btn--secondary">
                    {{ 'collections.clear_filters' | t }}
                  </a>
                {%- endif -%}
              {%- endif -%}
            </div>
          {%- endif -%}
        </div>
      </div>

    {%- endpaginate -%}
  </div>
</section>

{%- comment -%} JSON-LD Structured Data for Collection {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": {{ collection.title | json }},
  "description": {{ collection.description | strip_html | truncate: 5000 | default: collection.title | json }},
  "url": "{{ shop.url }}{{ collection.url }}",
  {%- if collection.image -%}
  "image": "https:{{ collection.image | image_url: width: 1200 }}",
  {%- endif -%}
  "numberOfItems": {{ collection.products_count }},
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": {{ collection.products_count }},
    "itemListElement": [
      {%- for product in collection.products limit: 10 -%}
      {
        "@type": "ListItem",
        "position": {{ forloop.index }},
        "url": "{{ shop.url }}{{ product.url }}"
      }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  }
}
</script>

{%- comment -%} Breadcrumb Schema for Collection {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": {{ 'general.home' | t | json }},
      "item": "{{ shop.url }}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": {{ collection.title | json }},
      "item": "{{ shop.url }}{{ collection.url }}"
    }
  ]
}
</script>

{% schema %}
{
  "name": "Collection products",
  "tag": "section",
  "class": "section-main-collection",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 4,
      "max": 24,
      "step": 4,
      "default": 12,
      "label": "Products per page"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "Desktop columns",
      "options": [
        { "value": "3", "label": "3 columns" },
        { "value": "4", "label": "4 columns" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Mobile columns",
      "options": [
        { "value": "1", "label": "1 column" },
        { "value": "2", "label": "2 columns" }
      ],
      "default": "2"
    },
    {
      "type": "header",
      "content": "Filtering and sorting"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true,
      "info": "Configure filters in Shopify Search & Discovery app"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Enable sorting",
      "default": true
    },
    {
      "type": "select",
      "id": "filter_style",
      "label": "Filter style",
      "options": [
        { "value": "drawer", "label": "Drawer (slide-in)" },
        { "value": "sidebar", "label": "Sidebar" }
      ],
      "default": "drawer"
    }
  ]
}
{% endschema %}
